"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getGithubBlameRanges = exports.queryGithubGraphql = exports.parseOwnerAndRepo = exports.getGithubReferenceData = exports.getGithubRepoDefaultBranch = exports.createPullRequest = exports.getGithubBranchList = exports.getGithubRepoList = exports.getGithubIsRemoteBranch = exports.getGithubPullRequestStatus = exports.getGithubIsUserCollaborator = exports.getGithubUsername = exports.githubValidateParams = void 0;
const request_error_1 = require("@octokit/request-error");
const octokit_1 = require("octokit");
const zod_1 = require("zod");
const scm_1 = require("./scm");
function removeTrailingSlash(str) {
    return str.trim().replace(/\/+$/, '');
}
const EnvVariablesZod = zod_1.z.object({
    GITHUB_API_TOKEN: zod_1.z.string().optional(),
});
const { GITHUB_API_TOKEN } = EnvVariablesZod.parse(process.env);
const GetBlameDocument = `
      query GetBlame(
        $owner: String!
        $repo: String!
        $ref: String!
        $path: String!
      ) {
        repository(name: $repo, owner: $owner) {
          # branch name
          object(expression: $ref) {
            # cast Target to a Commit
            ... on Commit {
              # full repo-relative path to blame file
              blame(path: $path) {
                ranges {
                  commit {
                    author {
                      user {
                        name
                        login
                      }
                    }
                    authoredDate
                  }
                  startingLine
                  endingLine
                  age
                }
              }
            }
            
          }
        }
      }
    `;
const githubUrlRegex = /^http[s]?:\/\/[^/\s]+\/([^/.\s]+\/[^/.\s]+)(\.git)?(\/)?$/i;
function getOktoKit(options) {
    const token = options?.githubAuthToken ?? GITHUB_API_TOKEN ?? '';
    return new octokit_1.Octokit({ auth: token });
}
async function githubValidateParams(url, accessToken) {
    try {
        const oktoKit = getOktoKit({ githubAuthToken: accessToken });
        if (accessToken) {
            await oktoKit.rest.users.getAuthenticated();
        }
        if (url) {
            const { owner, repo } = parseOwnerAndRepo(url);
            await oktoKit.rest.repos.get({ repo, owner });
        }
    }
    catch (e) {
        const error = e;
        const code = error.status ||
            error.statusCode ||
            error.response?.status ||
            error.response?.statusCode ||
            error.response?.code;
        if (code === 401 || code === 403) {
            throw new scm_1.InvalidAccessTokenError(`invalid github access token`);
        }
        if (code === 404) {
            throw new scm_1.InvalidRepoUrlError(`invalid github repo Url ${url}`);
        }
        throw e;
    }
}
exports.githubValidateParams = githubValidateParams;
async function getGithubUsername(accessToken) {
    const oktoKit = getOktoKit({ githubAuthToken: accessToken });
    const res = await oktoKit.rest.users.getAuthenticated();
    return res.data.login;
}
exports.getGithubUsername = getGithubUsername;
async function getGithubIsUserCollaborator(username, accessToken, repoUrl) {
    try {
        const { owner, repo } = parseOwnerAndRepo(repoUrl);
        const oktoKit = getOktoKit({ githubAuthToken: accessToken });
        const res = await oktoKit.rest.repos.checkCollaborator({
            owner,
            repo,
            username,
        });
        if (res.status === 204) {
            return true;
        }
    }
    catch (e) {
        return false;
    }
    return false;
}
exports.getGithubIsUserCollaborator = getGithubIsUserCollaborator;
async function getGithubPullRequestStatus(accessToken, repoUrl, prNumber) {
    const { owner, repo } = parseOwnerAndRepo(repoUrl);
    const oktoKit = getOktoKit({ githubAuthToken: accessToken });
    const res = await oktoKit.rest.pulls.get({
        owner,
        repo,
        pull_number: prNumber,
    });
    if (res.data.merged) {
        return 'merged';
    }
    if (res.data.draft) {
        return 'draft';
    }
    return res.data.state;
}
exports.getGithubPullRequestStatus = getGithubPullRequestStatus;
async function getGithubIsRemoteBranch(accessToken, repoUrl, branch) {
    const { owner, repo } = parseOwnerAndRepo(repoUrl);
    const oktoKit = getOktoKit({ githubAuthToken: accessToken });
    try {
        const res = await oktoKit.rest.repos.getBranch({
            owner,
            repo,
            branch,
        });
        return branch === res.data.name;
    }
    catch (e) {
        return false;
    }
}
exports.getGithubIsRemoteBranch = getGithubIsRemoteBranch;
async function getGithubRepoList(accessToken) {
    const oktoKit = getOktoKit({ githubAuthToken: accessToken });
    try {
        const githubRepos = await getRepos(oktoKit);
        return githubRepos.map((repo) => {
            const repoLanguages = [];
            if (repo.language) {
                repoLanguages.push(repo.language);
            }
            return {
                repoName: repo.name,
                repoUrl: repo.html_url,
                repoOwner: repo.owner.login,
                repoLanguages,
                repoIsPublic: !repo.private,
                repoUpdatedAt: repo.updated_at,
            };
        });
    }
    catch (e) {
        if (e instanceof request_error_1.RequestError && e.status === 401) {
            return [];
        }
        if (e instanceof request_error_1.RequestError && e.status === 404) {
            return [];
        }
        throw e;
    }
}
exports.getGithubRepoList = getGithubRepoList;
async function getGithubBranchList(accessToken, repoUrl) {
    const { owner, repo } = parseOwnerAndRepo(repoUrl);
    const oktoKit = getOktoKit({ githubAuthToken: accessToken });
    const res = await oktoKit.rest.repos.listBranches({
        owner,
        repo,
        per_page: 1000,
        page: 1,
    });
    return res.data.map((branch) => branch.name);
}
exports.getGithubBranchList = getGithubBranchList;
async function createPullRequest(options) {
    const { owner, repo } = parseOwnerAndRepo(options.repoUrl);
    const oktoKit = getOktoKit({ githubAuthToken: options.accessToken });
    const res = await oktoKit.rest.pulls.create({
        owner,
        repo,
        title: options.title,
        body: options.body,
        head: options.sourceBranchName,
        base: options.targetBranchName,
        draft: false,
        maintainer_can_modify: true,
    });
    return res.data.number;
}
exports.createPullRequest = createPullRequest;
async function getRepos(oktoKit) {
    // For now limit is 100(maximum supported by github) if we will need more we need to implement pagination + search
    const res = await oktoKit.request('GET /user/repos?sort=updated', {
        headers: {
            'X-GitHub-Api-Version': '2022-11-28',
            per_page: 100,
        },
    });
    return res.data;
}
async function getGithubRepoDefaultBranch(repoUrl, options) {
    const oktoKit = getOktoKit(options);
    const { owner, repo } = parseOwnerAndRepo(repoUrl);
    return (await oktoKit.rest.repos.get({ repo, owner })).data.default_branch;
}
exports.getGithubRepoDefaultBranch = getGithubRepoDefaultBranch;
async function getGithubReferenceData({ ref, gitHubUrl }, options) {
    const { owner, repo } = parseOwnerAndRepo(gitHubUrl);
    let res;
    try {
        const oktoKit = getOktoKit(options);
        res = await Promise.any([
            getBranch({ owner, repo, branch: ref }, oktoKit).then((result) => ({
                date: result.data.commit.commit.committer?.date
                    ? new Date(result.data.commit.commit.committer?.date)
                    : undefined,
                type: scm_1.ReferenceType.BRANCH,
                sha: result.data.commit.sha,
            })),
            getCommit({ commitSha: ref, repo, owner }, oktoKit).then((commit) => ({
                date: new Date(commit.data.committer.date),
                type: scm_1.ReferenceType.COMMIT,
                sha: commit.data.sha,
            })),
            getTagDate({ owner, repo, tag: ref }, oktoKit).then((data) => ({
                date: new Date(data.date),
                type: scm_1.ReferenceType.TAG,
                sha: data.sha,
            })),
        ]);
        return res;
    }
    catch (e) {
        // did not find any branch/tag/commit
        if (e instanceof AggregateError) {
            throw new scm_1.RefNotFoundError(`ref: ${ref} does not exist`);
        }
        throw e;
    }
}
exports.getGithubReferenceData = getGithubReferenceData;
async function getBranch({ branch, owner, repo }, oktoKit) {
    return oktoKit.rest.repos.getBranch({
        branch: branch,
        owner,
        repo,
    });
}
async function getTagDate({ tag, owner, repo }, oktoKit) {
    const refResponse = await oktoKit.rest.git.getRef({
        ref: `tags/${tag}`,
        owner,
        repo,
    });
    const tagSha = refResponse.data.object.sha;
    if (refResponse.data.object.type === 'commit') {
        const res = await oktoKit.rest.git.getCommit({
            commit_sha: tagSha,
            owner,
            repo,
        });
        return {
            date: res.data.committer.date,
            sha: res.data.sha,
        };
    }
    const res = await oktoKit.rest.git.getTag({
        tag_sha: tagSha,
        owner,
        repo,
    });
    return {
        date: res.data.tagger.date,
        sha: res.data.sha,
    };
}
async function getCommit({ commitSha, owner, repo, }, oktoKit) {
    return oktoKit.rest.git.getCommit({
        repo,
        owner,
        commit_sha: commitSha,
    });
}
function parseOwnerAndRepo(gitHubUrl) {
    gitHubUrl = removeTrailingSlash(gitHubUrl);
    if (!githubUrlRegex.test(gitHubUrl)) {
        throw new scm_1.InvalidUrlPatternError(`invalid github repo Url ${gitHubUrl}`);
    }
    const groups = gitHubUrl.split(githubUrlRegex).filter((res) => res);
    const ownerAndRepo = groups[0]?.split('/');
    const owner = ownerAndRepo?.at(0);
    const repo = ownerAndRepo?.at(1);
    if (!owner || !repo) {
        throw new scm_1.InvalidUrlPatternError(`invalid github repo Url ${gitHubUrl}`);
    }
    return { owner, repo };
}
exports.parseOwnerAndRepo = parseOwnerAndRepo;
async function queryGithubGraphql(query, variables, options) {
    const token = options?.githubAuthToken ?? GITHUB_API_TOKEN ?? '';
    const parameters = variables ?? {};
    const authorizationHeader = {
        headers: {
            authorization: `bearer ${token}`,
        },
    };
    try {
        const oktoKit = getOktoKit(options);
        const res = await oktoKit.graphql(query, {
            ...parameters,
            ...authorizationHeader,
        });
        return res;
    }
    catch (e) {
        if (e instanceof request_error_1.RequestError) {
            return null;
        }
        throw e;
    }
}
exports.queryGithubGraphql = queryGithubGraphql;
async function getGithubBlameRanges({ ref, gitHubUrl, path }, options) {
    const { owner, repo } = parseOwnerAndRepo(gitHubUrl);
    const variables = {
        owner,
        repo,
        path,
        ref,
    };
    const res = await queryGithubGraphql(GetBlameDocument, variables, options);
    if (!res?.repository?.object?.blame?.ranges) {
        return [];
    }
    return res.repository.object.blame.ranges.map((range) => ({
        startingLine: range.startingLine,
        endingLine: range.endingLine,
        email: range.commit.author.user.email,
        name: range.commit.author.user.name,
        login: range.commit.author.user.login,
    }));
}
exports.getGithubBlameRanges = getGithubBlameRanges;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2l0aHViLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL2FuYWx5c2lzL3NjbS9naXRodWIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMERBQXFEO0FBQ3JELHFDQUFpQztBQUNqQyw2QkFBdUI7QUFFdkIsK0JBTWM7QUFFZCxTQUFTLG1CQUFtQixDQUFDLEdBQVc7SUFDdEMsT0FBTyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQTtBQUN2QyxDQUFDO0FBRUQsTUFBTSxlQUFlLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztJQUMvQixnQkFBZ0IsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ3hDLENBQUMsQ0FBQTtBQUVGLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBSy9ELE1BQU0sZ0JBQWdCLEdBQUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7S0FrQ3BCLENBQUE7QUF5QkwsTUFBTSxjQUFjLEdBQ2xCLDREQUE0RCxDQUFBO0FBRTlELFNBQVMsVUFBVSxDQUFDLE9BQXdCO0lBQzFDLE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxlQUFlLElBQUksZ0JBQWdCLElBQUksRUFBRSxDQUFBO0lBQ2hFLE9BQU8sSUFBSSxpQkFBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7QUFDckMsQ0FBQztBQUVNLEtBQUssVUFBVSxvQkFBb0IsQ0FDeEMsR0FBdUIsRUFDdkIsV0FBK0I7SUFFL0IsSUFBSTtRQUNGLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxFQUFFLGVBQWUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFBO1FBQzVELElBQUksV0FBVyxFQUFFO1lBQ2YsTUFB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QUksQ0FBQyxLQUFLO1FBQ3JDLElBQUksRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSTtRQUNuQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUs7S0FDdEMsQ0FBQyxDQUFDLENBQUE7QUFDTCxDQUFDO0FBN0JELG9EQTZCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3RFcnJvciB9IGZyb20gJ0BvY3Rva2l0L3JlcXVlc3QtZXJyb3InXG5pbXBvcnQgeyBPY3Rva2l0IH0gZnJvbSAnb2N0b2tpdCdcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnXG5cbmltcG9ydCB7XG4gIEludmFsaWRBY2Nlc3NUb2tlbkVycm9yLFxuICBJbnZhbGlkUmVwb1VybEVycm9yLFxuICBJbnZhbGlkVXJsUGF0dGVybkVycm9yLFxuICBSZWZlcmVuY2VUeXBlLFxuICBSZWZOb3RGb3VuZEVycm9yLFxufSBmcm9tICcuL3NjbSdcblxuZnVuY3Rpb24gcmVtb3ZlVHJhaWxpbmdTbGFzaChzdHI6IHN0cmluZykge1xuICByZXR1cm4gc3RyLnRyaW0oKS5yZXBsYWNlKC9cXC8rJC8sICcnKVxufVxuXG5jb25zdCBFbnZWYXJpYWJsZXNab2QgPSB6Lm9iamVjdCh7XG4gIEdJVEhVQl9BUElfVE9LRU46IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbn0pXG5cbmNvbnN0IHsgR0lUSFVCX0FQSV9UT0tFTiB9ID0gRW52VmFyaWFibGVzWm9kLnBhcnNlKHByb2Nlc3MuZW52KVxuXG50eXBlIEFwaUF1dGhPcHRpb25zID0ge1xuICBnaXRodWJBdXRoVG9rZW4/OiBzdHJpbmcgfCBudWxsXG59XG5jb25zdCBHZXRCbGFtZURvY3VtZW50ID0gYFxuICAgICAgcXVlcnkgR2V0QmxhbWUoXG4gICAgICAgICRvd25lcjogU3RyaW5nIVxuICAgICAgICAkcmVwbzogU3RyaW5nIVxuICAgICAgICAkcmVmOiBTdHJpbmchXG4gICAgICAgICRwYXRoOiBTdHJpbmchXG4gICAgICApIHtcbiAgICAgICAgcmVwb3NpdG9yeShuYW1lOiAkcmVwbywgb3duZXI6ICRvd25lcikge1xuICAgICAgICAgICMgYnJhbmNoIG5hbWVcbiAgICAgICAgICBvYmplY3QoZXhwcmVzc2lvbjogJHJlZikge1xuICAgICAgICAgICAgIyBjYXN0IFRhcmdldCB0byBhIENvbW1pdFxuICAgICAgICAgICAgLi4uIG9uIENvbW1pdCB7XG4gICAgICAgICAgICAgICMgZnVsbCByZXBvLXJlbGF0aXZlIHBhdGggdG8gYmxhbWUgZmlsZVxuICAgICAgICAgICAgICBibGFtZShwYXRoOiAkcGF0aCkge1xuICAgICAgICAgICAgICAgIHJhbmdlcyB7XG4gICAgICAgICAgICAgICAgICBjb21taXQge1xuICAgICAgICAgICAgICAgICAgICBhdXRob3Ige1xuICAgICAgICAgICAgICAgICAgICAgIHVzZXIge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgbG9naW5cbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXV0aG9yZWREYXRlXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBzdGFydGluZ0xpbmVcbiAgICAgICAgICAgICAgICAgIGVuZGluZ0xpbmVcbiAgICAgICAgICAgICAgICAgIGFnZVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgYFxuXG5leHBvcnQgdHlwZSBHaXRodWJCbGFtZVJlc3BvbnNlID0ge1xuICByZXBvc2l0b3J5OiB7XG4gICAgb2JqZWN0OiB7XG4gICAgICBibGFtZToge1xuICAgICAgICByYW5nZXM6IEFycmF5PHtcbiAgICAgICAgICBhZ2U6IG51bWJlclxuICAgICAgICAgIGVuZGluZ0xpbmU6IG51bWJlclxuICAgICAgICAgIHN0YXJ0aW5nTGluZTogbnVtYmVyXG4gICAgICAgICAgY29tbWl0OiB7XG4gICAgICAgICAgICBhdXRob3I6IHtcbiAgICAgICAgICAgICAgdXNlcjoge1xuICAgICAgICAgICAgICAgIGVtYWlsOiBzdHJpbmdcbiAgICAgICAgICAgICAgICBuYW1lOiBzdHJpbmdcbiAgICAgICAgICAgICAgICBsb2dpbjogc3RyaW5nXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0+XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNvbnN0IGdpdGh1YlVybFJlZ2V4ID1cbiAgL15odHRwW3NdPzpcXC9cXC9bXi9cXHNdK1xcLyhbXi8uXFxzXStcXC9bXi8uXFxzXSspKFxcLmdpdCk/KFxcLyk/JC9pXG5cbmZ1bmN0aW9uIGdldE9rdG9LaXQob3B0aW9ucz86IEFwaUF1dGhPcHRpb25zKSB7XG4gIGNvbnN0IHRva2VuID0gb3B0aW9ucz8uZ2l0aHViQXV0aFRva2VuID8/IEdJVEhVQl9BUElfVE9LRU4gPz8gJydcbiAgcmV0dXJuIG5ldyBPY3Rva2l0KHsgYXV0aDogdG9rZW4gfSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdpdGh1YlZhbGlkYXRlUGFyYW1zKFxuICB1cmw6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgYWNjZXNzVG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZFxuKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQoeyBnaXRodWJBdXRoVG9rZW46IGFjY2Vzc1Rva2VuIH0pXG4gICAgaWYgKGFjY2Vzc1Rva2VuKSB7XG4gICAgICBhd2FpdCBva3RvS2l0LnJlc3QudXNlcnMuZ2V0QXV0aGVudGljYXRlZCgpXG4gICAgfVxuICAgIGlmICh1cmwpIHtcbiAgICAgIGNvbnN0IHsgb3duZXIsIHJlcG8gfSA9IHBhcnNlT3duZXJBbmRSZXBvKHVybClcbiAgICAgIGF3YWl0IG9rdG9LaXQucmVzdC5yZXBvcy5nZXQoeyByZXBvLCBvd25lciB9KVxuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnN0IGVycm9yID0gZSBhcyB7XG4gICAgICBjb2RlPzogc3RyaW5nXG4gICAgICBzdGF0dXM/OiBudW1iZXJcbiAgICAgIHN0YXR1c0NvZGU/OiBudW1iZXJcbiAgICAgIHJlc3BvbnNlPzogeyBzdGF0dXM/OiBudW1iZXI7IHN0YXR1c0NvZGU/OiBudW1iZXI7IGNvZGU/OiBzdHJpbmcgfVxuICAgIH1cbiAgICBjb25zdCBjb2RlID1cbiAgICAgIGVycm9yLnN0YXR1cyB8fFxuICAgICAgZXJyb3Iuc3RhdHVzQ29kZSB8fFxuICAgICAgZXJyb3IucmVzcG9uc2U/LnN0YXR1cyB8fFxuICAgICAgZXJyb3IucmVzcG9uc2U/LnN0YXR1c0NvZGUgfHxcbiAgICAgIGVycm9yLnJlc3BvbnNlPy5jb2RlXG4gICAgaWYgKGNvZGUgPT09IDQwMSB8fCBjb2RlID09PSA0MDMpIHtcbiAgICAgIHRocm93IG5ldyBJbnZhbGlkQWNjZXNzVG9rZW5FcnJvcihgaW52YWxpZCBnaXRodWIgYWNjZXNzIHRva2VuYClcbiAgICB9XG4gICAgaWYgKGNvZGUgPT09IDQwNCkge1xuICAgICAgdGhyb3cgbmV3IEludmFsaWRSZXBvVXJsRXJyb3IoYGludmFsaWQgZ2l0aHViIHJlcG8gVXJsICR7dXJsfWApXG4gICAgfVxuICAgIHRocm93IGVcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0R2l0aHViVXNlcm5hbWUoYWNjZXNzVG9rZW46IHN0cmluZykge1xuICBjb25zdCBva3RvS2l0ID0gZ2V0T2t0b0tpdCh7IGdpdGh1YkF1dGhUb2tlbjogYWNjZXNzVG9rZW4gfSlcbiAgY29uc3QgcmVzID0gYXdhaXQgb2t0b0tpdC5yZXN0LnVzZXJzLmdldEF1dGhlbnRpY2F0ZWQoKVxuICByZXR1cm4gcmVzLmRhdGEubG9naW5cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdpdGh1YklzVXNlckNvbGxhYm9yYXRvcihcbiAgdXNlcm5hbWU6IHN0cmluZyxcbiAgYWNjZXNzVG9rZW46IHN0cmluZyxcbiAgcmVwb1VybDogc3RyaW5nXG4pIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IG93bmVyLCByZXBvIH0gPSBwYXJzZU93bmVyQW5kUmVwbyhyZXBvVXJsKVxuICAgIGNvbnN0IG9rdG9LaXQgPSBnZXRPa3RvS2l0KHsgZ2l0aHViQXV0aFRva2VuOiBhY2Nlc3NUb2tlbiB9KVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IG9rdG9LaXQucmVzdC5yZXBvcy5jaGVja0NvbGxhYm9yYXRvcih7XG4gICAgICBvd25lcixcbiAgICAgIHJlcG8sXG4gICAgICB1c2VybmFtZSxcbiAgICB9KVxuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDQpIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbiAgcmV0dXJuIGZhbHNlXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHaXRodWJQdWxsUmVxdWVzdFN0YXR1cyhcbiAgYWNjZXNzVG9rZW46IHN0cmluZyxcbiAgcmVwb1VybDogc3RyaW5nLFxuICBwck51bWJlcjogbnVtYmVyXG4pIHtcbiAgY29uc3QgeyBvd25lciwgcmVwbyB9ID0gcGFyc2VPd25lckFuZFJlcG8ocmVwb1VybClcbiAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQoeyBnaXRodWJBdXRoVG9rZW46IGFjY2Vzc1Rva2VuIH0pXG4gIGNvbnN0IHJlcyA9IGF3YWl0IG9rdG9LaXQucmVzdC5wdWxscy5nZXQoe1xuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gICAgcHVsbF9udW1iZXI6IHByTnVtYmVyLFxuICB9KVxuICBpZiAocmVzLmRhdGEubWVyZ2VkKSB7XG4gICAgcmV0dXJuICdtZXJnZWQnXG4gIH1cbiAgaWYgKHJlcy5kYXRhLmRyYWZ0KSB7XG4gICAgcmV0dXJuICdkcmFmdCdcbiAgfVxuICByZXR1cm4gcmVzLmRhdGEuc3RhdGVcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdpdGh1YklzUmVtb3RlQnJhbmNoKFxuICBhY2Nlc3NUb2tlbjogc3RyaW5nLFxuICByZXBvVXJsOiBzdHJpbmcsXG4gIGJyYW5jaDogc3RyaW5nXG4pIHtcbiAgY29uc3QgeyBvd25lciwgcmVwbyB9ID0gcGFyc2VPd25lckFuZFJlcG8ocmVwb1VybClcbiAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQoeyBnaXRodWJBdXRoVG9rZW46IGFjY2Vzc1Rva2VuIH0pXG4gIHRyeSB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgb2t0b0tpdC5yZXN0LnJlcG9zLmdldEJyYW5jaCh7XG4gICAgICBvd25lcixcbiAgICAgIHJlcG8sXG4gICAgICBicmFuY2gsXG4gICAgfSlcbiAgICByZXR1cm4gYnJhbmNoID09PSByZXMuZGF0YS5uYW1lXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gZmFsc2VcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0R2l0aHViUmVwb0xpc3QoYWNjZXNzVG9rZW46IHN0cmluZykge1xuICBjb25zdCBva3RvS2l0ID0gZ2V0T2t0b0tpdCh7IGdpdGh1YkF1dGhUb2tlbjogYWNjZXNzVG9rZW4gfSlcbiAgdHJ5IHtcbiAgICBjb25zdCBnaXRodWJSZXBvcyA9IGF3YWl0IGdldFJlcG9zKG9rdG9LaXQpXG4gICAgcmV0dXJuIGdpdGh1YlJlcG9zLm1hcChcbiAgICAgIChyZXBvOiB7XG4gICAgICAgIGxhbmd1YWdlOiBzdHJpbmdcbiAgICAgICAgbmFtZTogc3RyaW5nXG4gICAgICAgIGh0bWxfdXJsOiBzdHJpbmdcbiAgICAgICAgb3duZXI6IHsgbG9naW46IHN0cmluZyB9XG4gICAgICAgIHByaXZhdGU6IGJvb2xlYW5cbiAgICAgICAgdXBkYXRlZF9hdDogc3RyaW5nXG4gICAgICB9KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcG9MYW5ndWFnZXMgPSBbXVxuICAgICAgICBpZiAocmVwby5sYW5ndWFnZSkge1xuICAgICAgICAgIHJlcG9MYW5ndWFnZXMucHVzaChyZXBvLmxhbmd1YWdlKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcmVwb05hbWU6IHJlcG8ubmFtZSxcbiAgICAgICAgICByZXBvVXJsOiByZXBvLmh0bWxfdXJsLFxuICAgICAgICAgIHJlcG9Pd25lcjogcmVwby5vd25lci5sb2dpbixcbiAgICAgICAgICByZXBvTGFuZ3VhZ2VzLFxuICAgICAgICAgIHJlcG9Jc1B1YmxpYzogIXJlcG8ucHJpdmF0ZSxcbiAgICAgICAgICByZXBvVXBkYXRlZEF0OiByZXBvLnVwZGF0ZWRfYXQsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZSBpbnN0YW5jZW9mIFJlcXVlc3RFcnJvciAmJiBlLnN0YXR1cyA9PT0gNDAxKSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gICAgaWYgKGUgaW5zdGFuY2VvZiBSZXF1ZXN0RXJyb3IgJiYgZS5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICAgIHRocm93IGVcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0R2l0aHViQnJhbmNoTGlzdChcbiAgYWNjZXNzVG9rZW46IHN0cmluZyxcbiAgcmVwb1VybDogc3RyaW5nXG4pIHtcbiAgY29uc3QgeyBvd25lciwgcmVwbyB9ID0gcGFyc2VPd25lckFuZFJlcG8ocmVwb1VybClcbiAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQoeyBnaXRodWJBdXRoVG9rZW46IGFjY2Vzc1Rva2VuIH0pXG4gIGNvbnN0IHJlcyA9IGF3YWl0IG9rdG9LaXQucmVzdC5yZXBvcy5saXN0QnJhbmNoZXMoe1xuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gICAgcGVyX3BhZ2U6IDEwMDAsXG4gICAgcGFnZTogMSxcbiAgfSlcbiAgcmV0dXJuIHJlcy5kYXRhLm1hcCgoYnJhbmNoKSA9PiBicmFuY2gubmFtZSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVB1bGxSZXF1ZXN0KG9wdGlvbnM6IHtcbiAgYWNjZXNzVG9rZW46IHN0cmluZ1xuICB0YXJnZXRCcmFuY2hOYW1lOiBzdHJpbmdcbiAgc291cmNlQnJhbmNoTmFtZTogc3RyaW5nXG4gIHRpdGxlOiBzdHJpbmdcbiAgYm9keTogc3RyaW5nXG4gIHJlcG9Vcmw6IHN0cmluZ1xufSkge1xuICBjb25zdCB7IG93bmVyLCByZXBvIH0gPSBwYXJzZU93bmVyQW5kUmVwbyhvcHRpb25zLnJlcG9VcmwpXG4gIGNvbnN0IG9rdG9LaXQgPSBnZXRPa3RvS2l0KHsgZ2l0aHViQXV0aFRva2VuOiBvcHRpb25zLmFjY2Vzc1Rva2VuIH0pXG4gIGNvbnN0IHJlcyA9IGF3YWl0IG9rdG9LaXQucmVzdC5wdWxscy5jcmVhdGUoe1xuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gICAgdGl0bGU6IG9wdGlvbnMudGl0bGUsXG4gICAgYm9keTogb3B0aW9ucy5ib2R5LFxuICAgIGhlYWQ6IG9wdGlvbnMuc291cmNlQnJhbmNoTmFtZSxcbiAgICBiYXNlOiBvcHRpb25zLnRhcmdldEJyYW5jaE5hbWUsXG4gICAgZHJhZnQ6IGZhbHNlLFxuICAgIG1haW50YWluZXJfY2FuX21vZGlmeTogdHJ1ZSxcbiAgfSlcbiAgcmV0dXJuIHJlcy5kYXRhLm51bWJlclxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZXBvcyhva3RvS2l0OiBPY3Rva2l0KSB7XG4gIC8vIEZvciBub3cgbGltaXQgaXMgMTAwKG1heGltdW0gc3VwcG9ydGVkIGJ5IGdpdGh1YikgaWYgd2Ugd2lsbCBuZWVkIG1vcmUgd2UgbmVlZCB0byBpbXBsZW1lbnQgcGFnaW5hdGlvbiArIHNlYXJjaFxuICBjb25zdCByZXMgPSBhd2FpdCBva3RvS2l0LnJlcXVlc3QoJ0dFVCAvdXNlci9yZXBvcz9zb3J0PXVwZGF0ZWQnLCB7XG4gICAgaGVhZGVyczoge1xuICAgICAgJ1gtR2l0SHViLUFwaS1WZXJzaW9uJzogJzIwMjItMTEtMjgnLFxuICAgICAgcGVyX3BhZ2U6IDEwMCxcbiAgICB9LFxuICB9KVxuICByZXR1cm4gcmVzLmRhdGFcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdpdGh1YlJlcG9EZWZhdWx0QnJhbmNoKFxuICByZXBvVXJsOiBzdHJpbmcsXG4gIG9wdGlvbnM/OiBBcGlBdXRoT3B0aW9uc1xuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQob3B0aW9ucylcbiAgY29uc3QgeyBvd25lciwgcmVwbyB9ID0gcGFyc2VPd25lckFuZFJlcG8ocmVwb1VybClcbiAgcmV0dXJuIChhd2FpdCBva3RvS2l0LnJlc3QucmVwb3MuZ2V0KHsgcmVwbywgb3duZXIgfSkpLmRhdGEuZGVmYXVsdF9icmFuY2hcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdpdGh1YlJlZmVyZW5jZURhdGEoXG4gIHsgcmVmLCBnaXRIdWJVcmwgfTogeyByZWY6IHN0cmluZzsgZ2l0SHViVXJsOiBzdHJpbmcgfSxcbiAgb3B0aW9ucz86IEFwaUF1dGhPcHRpb25zXG4pIHtcbiAgY29uc3QgeyBvd25lciwgcmVwbyB9ID0gcGFyc2VPd25lckFuZFJlcG8oZ2l0SHViVXJsKVxuICBsZXQgcmVzXG4gIHRyeSB7XG4gICAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQob3B0aW9ucylcbiAgICByZXMgPSBhd2FpdCBQcm9taXNlLmFueShbXG4gICAgICBnZXRCcmFuY2goeyBvd25lciwgcmVwbywgYnJhbmNoOiByZWYgfSwgb2t0b0tpdCkudGhlbigocmVzdWx0KSA9PiAoe1xuICAgICAgICBkYXRlOiByZXN1bHQuZGF0YS5jb21taXQuY29tbWl0LmNvbW1pdHRlcj8uZGF0ZVxuICAgICAgICAgID8gbmV3IERhdGUocmVzdWx0LmRhdGEuY29tbWl0LmNvbW1pdC5jb21taXR0ZXI/LmRhdGUpXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIHR5cGU6IFJlZmVyZW5jZVR5cGUuQlJBTkNILFxuICAgICAgICBzaGE6IHJlc3VsdC5kYXRhLmNvbW1pdC5zaGEsXG4gICAgICB9KSksXG4gICAgICBnZXRDb21taXQoeyBjb21taXRTaGE6IHJlZiwgcmVwbywgb3duZXIgfSwgb2t0b0tpdCkudGhlbigoY29tbWl0KSA9PiAoe1xuICAgICAgICBkYXRlOiBuZXcgRGF0ZShjb21taXQuZGF0YS5jb21taXR0ZXIuZGF0ZSksXG4gICAgICAgIHR5cGU6IFJlZmVyZW5jZVR5cGUuQ09NTUlULFxuICAgICAgICBzaGE6IGNvbW1pdC5kYXRhLnNoYSxcbiAgICAgIH0pKSxcbiAgICAgIGdldFRhZ0RhdGUoeyBvd25lciwgcmVwbywgdGFnOiByZWYgfSwgb2t0b0tpdCkudGhlbigoZGF0YSkgPT4gKHtcbiAgICAgICAgZGF0ZTogbmV3IERhdGUoZGF0YS5kYXRlKSxcbiAgICAgICAgdHlwZTogUmVmZXJlbmNlVHlwZS5UQUcsXG4gICAgICAgIHNoYTogZGF0YS5zaGEsXG4gICAgICB9KSksXG4gICAgXSlcbiAgICByZXR1cm4gcmVzXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBkaWQgbm90IGZpbmQgYW55IGJyYW5jaC90YWcvY29tbWl0XG4gICAgaWYgKGUgaW5zdGFuY2VvZiBBZ2dyZWdhdGVFcnJvcikge1xuICAgICAgdGhyb3cgbmV3IFJlZk5vdEZvdW5kRXJyb3IoYHJlZjogJHtyZWZ9IGRvZXMgbm90IGV4aXN0YClcbiAgICB9XG4gICAgdGhyb3cgZVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEJyYW5jaChcbiAgeyBicmFuY2gsIG93bmVyLCByZXBvIH06IHsgYnJhbmNoOiBzdHJpbmc7IG93bmVyOiBzdHJpbmc7IHJlcG86IHN0cmluZyB9LFxuICBva3RvS2l0OiBPY3Rva2l0XG4pIHtcbiAgcmV0dXJuIG9rdG9LaXQucmVzdC5yZXBvcy5nZXRCcmFuY2goe1xuICAgIGJyYW5jaDogYnJhbmNoLFxuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gIH0pXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFRhZ0RhdGUoXG4gIHsgdGFnLCBvd25lciwgcmVwbyB9OiB7IHRhZzogc3RyaW5nOyBvd25lcjogc3RyaW5nOyByZXBvOiBzdHJpbmcgfSxcbiAgb2t0b0tpdDogT2N0b2tpdFxuKSB7XG4gIGNvbnN0IHJlZlJlc3BvbnNlID0gYXdhaXQgb2t0b0tpdC5yZXN0LmdpdC5nZXRSZWYoe1xuICAgIHJlZjogYHRhZ3MvJHt0YWd9YCxcbiAgICBvd25lcixcbiAgICByZXBvLFxuICB9KVxuICBjb25zdCB0YWdTaGEgPSByZWZSZXNwb25zZS5kYXRhLm9iamVjdC5zaGFcbiAgaWYgKHJlZlJlc3BvbnNlLmRhdGEub2JqZWN0LnR5cGUgPT09ICdjb21taXQnKSB7XG4gICAgY29uc3QgcmVzID0gYXdhaXQgb2t0b0tpdC5yZXN0LmdpdC5nZXRDb21taXQoe1xuICAgICAgY29tbWl0X3NoYTogdGFnU2hhLFxuICAgICAgb3duZXIsXG4gICAgICByZXBvLFxuICAgIH0pXG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGU6IHJlcy5kYXRhLmNvbW1pdHRlci5kYXRlLFxuICAgICAgc2hhOiByZXMuZGF0YS5zaGEsXG4gICAgfVxuICB9XG4gIGNvbnN0IHJlcyA9IGF3YWl0IG9rdG9LaXQucmVzdC5naXQuZ2V0VGFnKHtcbiAgICB0YWdfc2hhOiB0YWdTaGEsXG4gICAgb3duZXIsXG4gICAgcmVwbyxcbiAgfSlcbiAgcmV0dXJuIHtcbiAgICBkYXRlOiByZXMuZGF0YS50YWdnZXIuZGF0ZSxcbiAgICBzaGE6IHJlcy5kYXRhLnNoYSxcbiAgfVxufVxuYXN5bmMgZnVuY3Rpb24gZ2V0Q29tbWl0KFxuICB7XG4gICAgY29tbWl0U2hhLFxuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gIH06IHsgY29tbWl0U2hhOiBzdHJpbmc7IG93bmVyOiBzdHJpbmc7IHJlcG86IHN0cmluZyB9LFxuICBva3RvS2l0OiBPY3Rva2l0XG4pIHtcbiAgcmV0dXJuIG9rdG9LaXQucmVzdC5naXQuZ2V0Q29tbWl0KHtcbiAgICByZXBvLFxuICAgIG93bmVyLFxuICAgIGNvbW1pdF9zaGE6IGNvbW1pdFNoYSxcbiAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlT3duZXJBbmRSZXBvKGdpdEh1YlVybDogc3RyaW5nKSB7XG4gIGdpdEh1YlVybCA9IHJlbW92ZVRyYWlsaW5nU2xhc2goZ2l0SHViVXJsKVxuICBpZiAoIWdpdGh1YlVybFJlZ2V4LnRlc3QoZ2l0SHViVXJsKSkge1xuICAgIHRocm93IG5ldyBJbnZhbGlkVXJsUGF0dGVybkVycm9yKGBpbnZhbGlkIGdpdGh1YiByZXBvIFVybCAke2dpdEh1YlVybH1gKVxuICB9XG4gIGNvbnN0IGdyb3VwcyA9IGdpdEh1YlVybC5zcGxpdChnaXRodWJVcmxSZWdleCkuZmlsdGVyKChyZXMpID0+IHJlcylcbiAgY29uc3Qgb3duZXJBbmRSZXBvID0gZ3JvdXBzWzBdPy5zcGxpdCgnLycpXG4gIGNvbnN0IG93bmVyID0gb3duZXJBbmRSZXBvPy5hdCgwKVxuICBjb25zdCByZXBvID0gb3duZXJBbmRSZXBvPy5hdCgxKVxuICBpZiAoIW93bmVyIHx8ICFyZXBvKSB7XG4gICAgdGhyb3cgbmV3IEludmFsaWRVcmxQYXR0ZXJuRXJyb3IoYGludmFsaWQgZ2l0aHViIHJlcG8gVXJsICR7Z2l0SHViVXJsfWApXG4gIH1cblxuICByZXR1cm4geyBvd25lciwgcmVwbyB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBxdWVyeUdpdGh1YkdyYXBocWw8VD4oXG4gIHF1ZXJ5OiBzdHJpbmcsXG4gIHZhcmlhYmxlcz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICBvcHRpb25zPzogQXBpQXV0aE9wdGlvbnNcbikge1xuICBjb25zdCB0b2tlbiA9IG9wdGlvbnM/LmdpdGh1YkF1dGhUb2tlbiA/PyBHSVRIVUJfQVBJX1RPS0VOID8/ICcnXG4gIGNvbnN0IHBhcmFtZXRlcnMgPSB2YXJpYWJsZXMgPz8ge31cbiAgY29uc3QgYXV0aG9yaXphdGlvbkhlYWRlciA9IHtcbiAgICBoZWFkZXJzOiB7XG4gICAgICBhdXRob3JpemF0aW9uOiBgYmVhcmVyICR7dG9rZW59YCxcbiAgICB9LFxuICB9XG4gIHRyeSB7XG4gICAgY29uc3Qgb2t0b0tpdCA9IGdldE9rdG9LaXQob3B0aW9ucylcbiAgICBjb25zdCByZXMgPSBhd2FpdCBva3RvS2l0LmdyYXBocWw8VD4ocXVlcnksIHtcbiAgICAgIC4uLnBhcmFtZXRlcnMsXG4gICAgICAuLi5hdXRob3JpemF0aW9uSGVhZGVyLFxuICAgIH0pXG4gICAgcmV0dXJuIHJlc1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGUgaW5zdGFuY2VvZiBSZXF1ZXN0RXJyb3IpIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuICAgIHRocm93IGVcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0R2l0aHViQmxhbWVSYW5nZXMoXG4gIHsgcmVmLCBnaXRIdWJVcmwsIHBhdGggfTogeyByZWY6IHN0cmluZzsgZ2l0SHViVXJsOiBzdHJpbmc7IHBhdGg6IHN0cmluZyB9LFxuICBvcHRpb25zPzogQXBpQXV0aE9wdGlvbnNcbikge1xuICBjb25zdCB7IG93bmVyLCByZXBvIH0gPSBwYXJzZU93bmVyQW5kUmVwbyhnaXRIdWJVcmwpXG5cbiAgY29uc3QgdmFyaWFibGVzID0ge1xuICAgIG93bmVyLFxuICAgIHJlcG8sXG4gICAgcGF0aCxcbiAgICByZWYsXG4gIH1cbiAgY29uc3QgcmVzID0gYXdhaXQgcXVlcnlHaXRodWJHcmFwaHFsPEdpdGh1YkJsYW1lUmVzcG9uc2U+KFxuICAgIEdldEJsYW1lRG9jdW1lbnQsXG4gICAgdmFyaWFibGVzLFxuICAgIG9wdGlvbnNcbiAgKVxuXG4gIGlmICghcmVzPy5yZXBvc2l0b3J5Py5vYmplY3Q/LmJsYW1lPy5yYW5nZXMpIHtcbiAgICByZXR1cm4gW11cbiAgfVxuXG4gIHJldHVybiByZXMucmVwb3NpdG9yeS5vYmplY3QuYmxhbWUucmFuZ2VzLm1hcCgocmFuZ2UpID0+ICh7XG4gICAgc3RhcnRpbmdMaW5lOiByYW5nZS5zdGFydGluZ0xpbmUsXG4gICAgZW5kaW5nTGluZTogcmFuZ2UuZW5kaW5nTGluZSxcbiAgICBlbWFpbDogcmFuZ2UuY29tbWl0LmF1dGhvci51c2VyLmVtYWlsLFxuICAgIG5hbWU6IHJhbmdlLmNvbW1pdC5hdXRob3IudXNlci5uYW1lLFxuICAgIGxvZ2luOiByYW5nZS5jb21taXQuYXV0aG9yLnVzZXIubG9naW4sXG4gIH0pKVxufVxuIl19