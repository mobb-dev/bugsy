"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.sanityRepoURL = exports.parseScmURL = void 0;
const scm_1 = require("./scm");
function getRepoInfo(pathname, hostname, scmType) {
    const hostnameParts = hostname.split('.');
    if (hostnameParts.length === 3 &&
        hostnameParts[1] === 'visualstudio' &&
        hostnameParts[2] === 'com') {
        if (pathname.length === 2 && pathname[0] === '_git') {
            return {
                organization: hostnameParts[0],
                projectName: pathname[1],
                repoName: pathname[1],
            };
        }
        if (pathname.length === 3 && pathname[1] === '_git') {
            return {
                organization: hostnameParts[0],
                projectName: pathname[0],
                repoName: pathname[2],
            };
        }
    }
    if (hostname === 'dev.azure.com' || scmType === scm_1.ScmType.Ado) {
        if (pathname.length === 3 && pathname[1] === '_git') {
            return {
                organization: pathname[0],
                projectName: pathname[2],
                repoName: pathname[2],
            };
        }
        if (pathname.length === 4 && pathname[2] === '_git') {
            return {
                organization: pathname[0],
                projectName: pathname[1],
                repoName: pathname[3],
            };
        }
    }
    if (hostname === 'github.com' || scmType === scm_1.ScmType.GitHub) {
        if (pathname.length === 2) {
            return {
                organization: pathname[0],
                projectName: undefined,
                repoName: pathname[1],
            };
        }
    }
    if (hostname === 'gitlab.com' || scmType === scm_1.ScmType.GitLab) {
        if (pathname.length >= 2) {
            return {
                organization: pathname[0],
                projectName: undefined,
                repoName: pathname[pathname.length - 1],
            };
        }
    }
    return null;
}
const NAME_REGEX = /[a-z0-9\-_.+]+/i;
const parseScmURL = (scmURL, scmType) => {
    try {
        const url = new URL(scmURL);
        const hostname = url.hostname.toLowerCase();
        const projectPath = url.pathname.substring(1).replace(/.git$/i, '');
        const repo = getRepoInfo(projectPath.split('/'), hostname, scmType);
        if (!repo)
            return null;
        const { organization, repoName, projectName } = repo;
        if (!organization || !repoName)
            return null;
        if (!organization.match(NAME_REGEX) || !repoName.match(NAME_REGEX))
            return null;
        return {
            hostname,
            organization,
            projectPath,
            repoName,
            projectName,
            pathElements: projectPath.split('/'),
        };
    }
    catch (e) {
        return null;
    }
};
exports.parseScmURL = parseScmURL;
//check in general that the URL is a valid repo URL (GH, GL, ADO, on prem options as well)
//make sure that it has a user/org and a repo name but that the path doesn't have more than 4 parts
//make sure that the path parts are valid names for repo/user/org names
const sanityRepoURL = (scmURL) => {
    try {
        const url = new URL(scmURL);
        const projectPath = url.pathname.substring(1).replace(/.git$/i, '');
        const pathParts = projectPath.split('/');
        if (pathParts.length < 2)
            return false;
        if (pathParts.length > 4)
            return false;
        if (pathParts.some((part) => !part.match(NAME_REGEX)))
            return false;
        return true;
    }
    catch (e) {
        return null;
    }
};
exports.sanityRepoURL = sanityRepoURL;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJsUGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL2FuYWx5c2lzL3NjbS91cmxQYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBUS9CLFNBQVMsV0FBVyxDQUNsQixRQUFrQixFQUNsQixRQUFnQixFQUNoQixPQUFpQjtJQUVqQixNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ3pDLElBQ0UsYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDO1FBQzFCLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxjQUFjO1FBQ25DLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLEVBQzFCO1FBQ0EsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxFQUFFO1lBQ25ELE9BQU87Z0JBQ0wsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7Z0JBQzlCLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUN4QixRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQzthQUN0QixDQUFBO1NBQ0Y7UUFDRCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLEVBQUU7WUFDbkQsT0FBTztnQkFDTCxZQUFZLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQztnQkFDOUIsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hCLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO2FBQ3RCLENBQUE7U0FDRjtLQUNGO0lBQ0QsSUFBSSxRQUFRLEtBQUssZUFBZSxJQUFJLE9BQU8sS0FBSyxhQUFPLENBQUMsR0FBRyxFQUFFO1FBQzNELElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxD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QXVFO0FBQ2hFLE1BQU0sYUFBYSxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUU7SUFDOUMsSUFBSTtRQUNGLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQzNCLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDbkUsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUN4QyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUFFLE9BQU8sS0FBSyxDQUFBO1FBQ3RDLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUE7UUFDdEMsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQTtRQUNuRSxPQUFPLElBQUksQ0FBQTtLQUNaO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixPQUFPLElBQUksQ0FBQTtLQUNaO0FBQ0gsQ0FBQyxDQUFBO0FBWlksUUFBQSxhQUFhLGlCQVl6QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjbVR5cGUgfSBmcm9tICcuL3NjbSdcblxudHlwZSBSZXBvID0ge1xuICByZXBvTmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkXG4gIG9yZ2FuaXphdGlvbjogc3RyaW5nIHwgdW5kZWZpbmVkXG4gIHByb2plY3ROYW1lOiBzdHJpbmcgfCB1bmRlZmluZWRcbn0gfCBudWxsXG5cbmZ1bmN0aW9uIGdldFJlcG9JbmZvKFxuICBwYXRobmFtZTogc3RyaW5nW10sXG4gIGhvc3RuYW1lOiBzdHJpbmcsXG4gIHNjbVR5cGU/OiBTY21UeXBlXG4pOiBSZXBvIHtcbiAgY29uc3QgaG9zdG5hbWVQYXJ0cyA9IGhvc3RuYW1lLnNwbGl0KCcuJylcbiAgaWYgKFxuICAgIGhvc3RuYW1lUGFydHMubGVuZ3RoID09PSAzICYmXG4gICAgaG9zdG5hbWVQYXJ0c1sxXSA9PT0gJ3Zpc3VhbHN0dWRpbycgJiZcbiAgICBob3N0bmFtZVBhcnRzWzJdID09PSAnY29tJ1xuICApIHtcbiAgICBpZiAocGF0aG5hbWUubGVuZ3RoID09PSAyICYmIHBhdGhuYW1lWzBdID09PSAnX2dpdCcpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yZ2FuaXphdGlvbjogaG9zdG5hbWVQYXJ0c1swXSxcbiAgICAgICAgcHJvamVjdE5hbWU6IHBhdGhuYW1lWzFdLFxuICAgICAgICByZXBvTmFtZTogcGF0aG5hbWVbMV0sXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChwYXRobmFtZS5sZW5ndGggPT09IDMgJiYgcGF0aG5hbWVbMV0gPT09ICdfZ2l0Jykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgb3JnYW5pemF0aW9uOiBob3N0bmFtZVBhcnRzWzBdLFxuICAgICAgICBwcm9qZWN0TmFtZTogcGF0aG5hbWVbMF0sXG4gICAgICAgIHJlcG9OYW1lOiBwYXRobmFtZVsyXSxcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKGhvc3RuYW1lID09PSAnZGV2LmF6dXJlLmNvbScgfHwgc2NtVHlwZSA9PT0gU2NtVHlwZS5BZG8pIHtcbiAgICBpZiAocGF0aG5hbWUubGVuZ3RoID09PSAzICYmIHBhdGhuYW1lWzFdID09PSAnX2dpdCcpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yZ2FuaXphdGlvbjogcGF0aG5hbWVbMF0sXG4gICAgICAgIHByb2plY3ROYW1lOiBwYXRobmFtZVsyXSxcbiAgICAgICAgcmVwb05hbWU6IHBhdGhuYW1lWzJdLFxuICAgICAgfVxuICAgIH1cbiAgICBpZiAocGF0aG5hbWUubGVuZ3RoID09PSA0ICYmIHBhdGhuYW1lWzJdID09PSAnX2dpdCcpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yZ2FuaXphdGlvbjogcGF0aG5hbWVbMF0sXG4gICAgICAgIHByb2plY3ROYW1lOiBwYXRobmFtZVsxXSxcbiAgICAgICAgcmVwb05hbWU6IHBhdGhuYW1lWzNdLFxuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAoaG9zdG5hbWUgPT09ICdnaXRodWIuY29tJyB8fCBzY21UeXBlID09PSBTY21UeXBlLkdpdEh1Yikge1xuICAgIGlmIChwYXRobmFtZS5sZW5ndGggPT09IDIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yZ2FuaXphdGlvbjogcGF0aG5hbWVbMF0sXG4gICAgICAgIHByb2plY3ROYW1lOiB1bmRlZmluZWQsXG4gICAgICAgIHJlcG9OYW1lOiBwYXRobmFtZVsxXSxcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKGhvc3RuYW1lID09PSAnZ2l0bGFiLmNvbScgfHwgc2NtVHlwZSA9PT0gU2NtVHlwZS5HaXRMYWIpIHtcbiAgICBpZiAocGF0aG5hbWUubGVuZ3RoID49IDIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIG9yZ2FuaXphdGlvbjogcGF0aG5hbWVbMF0sXG4gICAgICAgIHByb2plY3ROYW1lOiB1bmRlZmluZWQsXG4gICAgICAgIHJlcG9OYW1lOiBwYXRobmFtZVtwYXRobmFtZS5sZW5ndGggLSAxXSxcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbnVsbFxufVxuXG5jb25zdCBOQU1FX1JFR0VYID0gL1thLXowLTlcXC1fLitdKy9pXG5cbmV4cG9ydCBjb25zdCBwYXJzZVNjbVVSTCA9IChzY21VUkw6IHN0cmluZywgc2NtVHlwZT86IFNjbVR5cGUpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKHNjbVVSTClcbiAgICBjb25zdCBob3N0bmFtZSA9IHVybC5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpXG4gICAgY29uc3QgcHJvamVjdFBhdGggPSB1cmwucGF0aG5hbWUuc3Vic3RyaW5nKDEpLnJlcGxhY2UoLy5naXQkL2ksICcnKVxuXG4gICAgY29uc3QgcmVwbyA9IGdldFJlcG9JbmZvKHByb2plY3RQYXRoLnNwbGl0KCcvJyksIGhvc3RuYW1lLCBzY21UeXBlKVxuXG4gICAgaWYgKCFyZXBvKSByZXR1cm4gbnVsbFxuXG4gICAgY29uc3QgeyBvcmdhbml6YXRpb24sIHJlcG9OYW1lLCBwcm9qZWN0TmFtZSB9ID0gcmVwb1xuXG4gICAgaWYgKCFvcmdhbml6YXRpb24gfHwgIXJlcG9OYW1lKSByZXR1cm4gbnVsbFxuICAgIGlmICghb3JnYW5pemF0aW9uLm1hdGNoKE5BTUVfUkVHRVgpIHx8ICFyZXBvTmFtZS5tYXRjaChOQU1FX1JFR0VYKSlcbiAgICAgIHJldHVybiBudWxsXG5cbiAgICByZXR1cm4ge1xuICAgICAgaG9zdG5hbWUsXG4gICAgICBvcmdhbml6YXRpb24sXG4gICAgICBwcm9qZWN0UGF0aCxcbiAgICAgIHJlcG9OYW1lLFxuICAgICAgcHJvamVjdE5hbWUsXG4gICAgICBwYXRoRWxlbWVudHM6IHByb2plY3RQYXRoLnNwbGl0KCcvJyksXG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxufVxuXG4vL2NoZWNrIGluIGdlbmVyYWwgdGhhdCB0aGUgVVJMIGlzIGEgdmFsaWQgcmVwbyBVUkwgKEdILCBHTCwgQURPLCBvbiBwcmVtIG9wdGlvbnMgYXMgd2VsbClcbi8vbWFrZSBzdXJlIHRoYXQgaXQgaGFzIGEgdXNlci9vcmcgYW5kIGEgcmVwbyBuYW1lIGJ1dCB0aGF0IHRoZSBwYXRoIGRvZXNuJ3QgaGF2ZSBtb3JlIHRoYW4gNCBwYXJ0c1xuLy9tYWtlIHN1cmUgdGhhdCB0aGUgcGF0aCBwYXJ0cyBhcmUgdmFsaWQgbmFtZXMgZm9yIHJlcG8vdXNlci9vcmcgbmFtZXNcbmV4cG9ydCBjb25zdCBzYW5pdHlSZXBvVVJMID0gKHNjbVVSTDogc3RyaW5nKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXJsID0gbmV3IFVSTChzY21VUkwpXG4gICAgY29uc3QgcHJvamVjdFBhdGggPSB1cmwucGF0aG5hbWUuc3Vic3RyaW5nKDEpLnJlcGxhY2UoLy5naXQkL2ksICcnKVxuICAgIGNvbnN0IHBhdGhQYXJ0cyA9IHByb2plY3RQYXRoLnNwbGl0KCcvJylcbiAgICBpZiAocGF0aFBhcnRzLmxlbmd0aCA8IDIpIHJldHVybiBmYWxzZVxuICAgIGlmIChwYXRoUGFydHMubGVuZ3RoID4gNCkgcmV0dXJuIGZhbHNlXG4gICAgaWYgKHBhdGhQYXJ0cy5zb21lKChwYXJ0KSA9PiAhcGFydC5tYXRjaChOQU1FX1JFR0VYKSkpIHJldHVybiBmYWxzZVxuICAgIHJldHVybiB0cnVlXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbFxuICB9XG59XG4iXX0=